!function(){return function e(t,i,s){function r(o,a){if(!i[o]){if(!t[o]){var d="function"==typeof require&&require;if(!a&&d)return d(o,!0);if(n)return n(o,!0);var h=new Error("Cannot find module '"+o+"'");throw h.code="MODULE_NOT_FOUND",h}var E=i[o]={exports:{}};t[o][0].call(E.exports,function(e){return r(t[o][1][e]||e)},E,E.exports,e,t,i,s)}return i[o].exports}for(var n="function"==typeof require&&require,o=0;o<s.length;o++)r(s[o]);return r}}()({1:[function(e,t,i){"use strict";OO.plugin("DiscoveryApi",function(e,t,i,s){e.EVENTS.DISCOVERY_API={RELATED_VIDEOS_FETCHED:"relatedVideosFetched",SEND_DISPLAY_EVENT:"sendDisplayEvent",DISPLAY_EVENT_SUCCESS:"displayEventSuccess",SEND_CLICK_EVENT:"sendClickEvent",CLICK_EVENT_SUCCESS:"clickEventSuccess",DISPLAY_EVENT_ERROR:"displayEventError",CLICK_EVENT_ERROR:"clickEventError"};var r=[];e.exposeStaticApi("EVENTS",e.EVENTS);var n=function(t,i){e.requiredInEnvironment("html5-playback")&&(this.id=i,this.mb=t,this.error=!1,this.wasContentChangedByApi=!1,this.currentContentId=null,this.playerParams={},this.relatedVideos=[],this.relatedVideosCache=[],this.backHistory=[],this.forwardHistory=[],this.guid="",this.apiHost=e.playerParams.backlot_api_write_server||"api.ooyala.com",e.StateMachine.create({initial:"Init",messageBus:this.mb,moduleName:"DiscoveryApi",target:this,events:[{name:e.EVENTS.SET_EMBED_CODE,from:"*"},{name:e.EVENTS.SET_ASSET,from:"*"},{name:e.EVENTS.EMBED_CODE_CHANGED,from:"*"},{name:e.EVENTS.EMBED_CODE_CHANGED_AFTER_OOYALA_AD,from:"*"},{name:e.EVENTS.ASSET_CHANGED,from:"*"},{name:e.EVENTS.ASSET_UPDATED,from:"*"},{name:e.EVENTS.DISCOVERY_API.SEND_DISPLAY_EVENT,from:"*"},{name:e.EVENTS.DISCOVERY_API.SEND_CLICK_EVENT,from:"*"},{name:e.EVENTS.REQUEST_PREVIOUS_VIDEO,from:"*"},{name:e.EVENTS.REQUEST_NEXT_VIDEO,from:"*"},{name:e.EVENTS.GUID_SET,from:"*"}]}))};return t.extend(n.prototype,{_tryUpdateHistoryOnContentChange:function(){this.currentContentId&&!this.wasContentChangedByApi&&this.backHistory.push(this.currentContentId),this.wasContentChangedByApi=!1},onSetEmbedCode:function(e,t,i){i&&i.ooyalaAds||this._tryUpdateHistoryOnContentChange()},onSetAsset:function(){this._tryUpdateHistoryOnContentChange()},onEmbedCodeChanged:function(e,t,i){this._handleEmbedCodeChanged(t,i)},onEmbedCodeChangedAfterOoyalaAd:function(e,t,i){this._handleEmbedCodeChanged(t,i)},_handleEmbedCodeChanged:function(e,i){if(!i||!i.ooyalaAds)if(this.currentContentId||this.relatedVideosCache.push({embed_code:e}),this.currentContentId=e,this.playerParams=i,(r=t.filter(r,function(t){return t!==e})).push(e),r.length>=20&&r.shift(),""===this.guid){var s=t.bind(function(){this._fetchRelatedVideos(e)},this);setTimeout(s,500)}else this._fetchRelatedVideos(e)},onAssetUpdated:function(e,t){this._setRelatedMedia(t)},onAssetChanged:function(e,t){this.currentContentId||this.relatedVideosCache.push({asset:t}),this.currentContentId=t.id,this._setRelatedMedia(t)},onRequestPreviousVideo:function(){this._switchVideo(!0)},onRequestNextVideo:function(){this._switchVideo(!1)},_switchVideo:function(t){var i,s=!1,r=t?this.backHistory:this.forwardHistory,n=t?this.forwardHistory:this.backHistory,o=r.pop();o?i=this._findVideoInCache(o):t||(i=this.relatedVideos[0],s=!0),i&&(i.embed_code||i.asset)?(n.push(this.currentContentId),this.wasContentChangedByApi=!0,i.embed_code?this.mb.publish(e.EVENTS.SET_EMBED_CODE,i.embed_code,this.playerParams):i.asset&&this.mb.publish(e.EVENTS.SET_ASSET,i.asset),s&&this.mb.publish(e.EVENTS.DISCOVERY_API.SEND_CLICK_EVENT,{clickedVideo:i,custom:{source:"endScreen",autoplay:!1,countdown:0}})):e.log("Discovery: Video switch failed for content id:",o)},_setRelatedMedia:function(t){t.relatedVideos&&(this.relatedVideos=t.relatedVideos,this.mb.publish(e.EVENTS.DISCOVERY_API.RELATED_VIDEOS_FETCHED,{videos:this.relatedVideos}))},onGuidSet:function(e,t){this.guid=t},onSendDisplayEvent:function(s,r){if(r){var n=JSON.parse(JSON.stringify(r)),o=n.relatedVideos;if(o&&t.isArray(o)&&!(t.size(o)<1)){var a=o[0].bucket_info;if(a)if("2"!==a.charAt(0)){n={bucket_info:a,custom:n.custom};var d="http://"+this.apiHost+"/v2/discover/feedback/impression";n.device_id=this.guid,n.discovery_profile_id=e.playerParams.playerBrandingId,n.system="OOYALA",i.ajax({url:d,data:JSON.stringify(n),type:"POST",dataType:"json",crossDomain:!0,cache:!0,success:t.bind(this._displayEventSuccess,this),error:t.bind(this._displayEventError,this)})}else this.mb.publish(e.EVENTS.REPORT_DISCOVERY_IMPRESSION,n)}}},_displayEventSuccess:function(){this.mb.publish(e.EVENTS.DISCOVERY_API.DISPLAY_EVENT_SUCCESS)},_displayEventError:function(t,i,s){this.mb.publish(e.EVENTS.DISCOVERY_API.DISPLAY_EVENT_ERROR,{xhr:t,status:i,error:s})},onSendClickEvent:function(s,r){if(r&&r.clickedVideo&&r.clickedVideo.bucket_info){var n=JSON.parse(JSON.stringify(r)),o=n.clickedVideo.bucket_info;if("2"!==o.charAt(0)){n={bucket_info:o,custom:n.custom};var a="http://"+this.apiHost+"/v2/discover/feedback/play";n.device_id=this.guid,n.discovery_profile_id=e.playerParams.playerBrandingId,n.system="OOYALA",i.ajax({url:a,data:JSON.stringify(n),type:"POST",dataType:"json",crossDomain:!0,cache:!0,success:t.bind(this._clickEventSuccess,this),error:t.bind(this._clickEventError,this)})}else this.mb.publish(e.EVENTS.REPORT_DISCOVERY_CLICK,n)}},_clickEventSuccess:function(){this.mb.publish(e.EVENTS.DISCOVERY_API.CLICK_EVENT_SUCCESS)},_clickEventError:function(t,i,s){this.mb.publish(e.EVENTS.DISCOVERY_API.CLICK_EVENT_ERROR,{xhr:t,status:i,error:s})},_fetchRelatedVideos:function(s){this.error=!1,this.relatedVideos=[];var r={sign_version:"player",pcode:e.playerParams.pcode,discovery_profile_id:e.playerParams.playerBrandingId,video_pcode:e.playerParams.pcode,limit:20,device_id:this.guid,expected_bucket_info_version:2,expires:Math.floor((new Date).getTime()/1e3+3600)},n=encodeURIComponent(this._generateSignature(r));r.device_id=encodeURIComponent(r.device_id);var o="//"+this.apiHost+"/v2/discover/similar/assets/"+s+"?"+this._generateParamString(r,n);i.ajax({url:o,type:"GET",dataType:"json",crossDomain:!0,cache:!0,success:t.bind(this._onRelatedVideosFetched,this),error:t.bind(this._onApiError,this)})},_onRelatedVideosFetched:function(t){var i=e.HM.safeObject("discovery.relatedVideos",t,{});void 0===i.errors||i.errors&&0===i.errors.code?(this.relatedVideos=i.results||[],this.variationIds=i.variation_ids):(this.relatedVideos=[],this.variationIds=[]),this._reorderRelatedVideos(),this._updateRelatedVideosCache();var s=this._getUpNextVideoFromHistory();this.mb.publish(e.EVENTS.REPORT_EXPERIMENT_VARIATIONS,{variationIds:this.variationIds}),this.mb.publish(e.EVENTS.DISCOVERY_API.RELATED_VIDEOS_FETCHED,{videos:this.relatedVideos,upNextVideo:s});var r=this._determinePositionInPlaylist();this.mb.publish(e.EVENTS.POSITION_IN_PLAYLIST_DETERMINED,r)},_onApiError:function(t,i,s){this.error=!0,this.mb.publish(e.EVENTS.DISCOVERY_API.RELATED_VIDEOS_FETCHED,{error:!0})},_determinePositionInPlaylist:function(){return{hasPreviousVideos:!!this.backHistory.length,hasNextVideos:!(!this.forwardHistory.length&&!this.relatedVideos.length)}},_getUpNextVideoFromHistory:function(){var e=null,t=null;return this.forwardHistory.length&&(t=this.forwardHistory[this.forwardHistory.length-1]),t&&(e=this._findVideoInCache(t)),e},_updateRelatedVideosCache:function(){this.relatedVideos.forEach(function(e){var t;e.embed_code?t=e.embed_code:e.asset&&(t=e.asset.id);var i=this._findVideoIndexInCache(t);i<0?this.relatedVideosCache.push(e):this.relatedVideosCache[i]=e},this)},_findVideoInCache:function(e){return t.find(this.relatedVideosCache,function(t){return t.embed_code?t.embed_code===e:!!t.asset&&t.asset.id===e})},_findVideoIndexInCache:function(e){for(var t,i=0;i<this.relatedVideosCache.length;i++)if((t=this.relatedVideosCache[i]).embed_code===e||t.asset&&t.asset.id===e)return i;return-1},_generateSignature:function(e){var i=e.pcode,s=t.reject(t.keys(e),function(e){return"pcode"===e});return new jsSHA(i+this._hashToString(e,"",s),"ASCII").getHash("SHA-256","B64").substring(0,43)},_hashToString:function(e,i,s){var r="",n=s||t.keys(e);return t.each(t.sortBy(n,function(e){return e}),function(t){r+=i+t+"="+e[t]}),r},_generateParamString:function(e,t){return"signature="+t+this._hashToString(e,"&")},_reorderRelatedVideos:function(){for(var e=this,i=function(i){var s=t.find(e.relatedVideos,function(e){return e.embed_code===r[i]});s&&(e.relatedVideos=t.filter(e.relatedVideos,function(e){return e.embed_code!==r[i]}),e.relatedVideos.push(s))},s=0;s<r.length;s++)i(s)}}),n})},{}]},{},[1]);